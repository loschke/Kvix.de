---
import { getCollection } from 'astro:content';
import Layout from '../../../layouts/Layout.astro';

export async function getStaticPaths() {
    const posts = await getCollection('blog', ({ data }) => {
        return import.meta.env.PROD ? !data.draft : true;
    });
    
    const categories = [...new Set(posts.flatMap(post => post.data.categories))];
    
    return categories.map(category => ({
        params: { category: category.toLowerCase() },
        props: { 
            category,
            posts: posts.filter(post => 
                post.data.categories.map(c => c.toLowerCase()).includes(category.toLowerCase())
            )
        },
    }));
}

const { category, posts } = Astro.props;

// Sort posts by date
const sortedPosts = posts.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Format date
const formatDate = (date: Date) => {
    return new Date(date).toLocaleDateString('de-DE', {
        year: 'numeric',
        month: 'long'
    });
};
---

<Layout
    title={`${category} - Blog - Rico Loschke`}
    description={`Alle Blogbeiträge in der Kategorie ${category}`}
>
    <section class="container-padding">
        <div class="max-w-3xl mx-auto">
            <div class="mb-12">
                <a href="/blog" class="text-primary hover:text-primary-light transition-colors">&larr; Zurück zum Blog</a>
                <h1 class="text-4xl md:text-5xl font-bold mt-4">Kategorie: {category}</h1>
            </div>

            <!-- Blog Posts -->
            <div class="flex flex-col gap-8">
                {sortedPosts.map((post) => (
                    <article class="flex flex-col md:flex-row gap-6 bg-background-light/5 rounded-xl overflow-hidden border border-white/10 hover:border-primary/50 transition-colors">
                        <div class="md:w-1/3">
                            {post.data.heroImage ? (
                                <img
                                    src={post.data.heroImage}
                                    alt={post.data.title}
                                    class="w-full h-full object-cover aspect-[3/2]"
                                />
                            ) : (
                                <div class="w-full h-full bg-background-light/10 aspect-[3/2]"></div>
                            )}
                        </div>
                        
                        <div class="flex flex-col p-6 md:w-2/3">
                            <div class="flex flex-wrap items-center gap-4 text-sm text-white/60 mb-4">
                                <time datetime={post.data.pubDate.toISOString()}>
                                    {formatDate(post.data.pubDate)}
                                </time>
                                <div class="flex flex-wrap gap-2">
                                    {post.data.categories.map((cat) => (
                                        <a
                                            href={`/blog/category/${cat.toLowerCase()}`}
                                            class="px-3 py-1 bg-primary/10 rounded-full hover:bg-primary/20 transition-colors"
                                        >
                                            {cat}
                                        </a>
                                    ))}
                                </div>
                            </div>
                            
                            <h2 class="text-2xl font-bold mb-4">
                                {post.data.title}
                            </h2>
                            
                            <p class="text-white/80 mb-6 flex-grow">
                                {post.data.description}
                            </p>
                            
                            <a
                                href={`/blog/${post.slug}`}
                                class="inline-flex items-center text-primary hover:text-primary-light transition-colors mt-auto"
                            >
                                Weiterlesen
                                <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    class="h-4 w-4 ml-2"
                                    viewBox="0 0 20 20"
                                    fill="currentColor"
                                >
                                    <path
                                        fill-rule="evenodd"
                                        d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z"
                                        clip-rule="evenodd"
                                    ></path>
                                </svg>
                            </a>
                        </div>
                    </article>
                ))}
            </div>
        </div>
    </section>
</Layout>
